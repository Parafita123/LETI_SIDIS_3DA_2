@startuml
title Saga + CQRS: Paciente agenda consulta e vê lista de consultas

actor "Paciente" as PatientUI
participant "API Gateway" as APIGW
participant "Scheduling Command API" as SchedCmd
database "Scheduling Write DB" as WDB
queue "Message Broker (AMQP)" as Broker
participant "Patient Service" as PatSvc
participant "Physician Service" as DocSvc
participant "Scheduling Query API (instância 1)" as SchedQ1
database "Consultations Read DB #1" as RDB1

== Comando: agendar consulta ==

PatientUI -> APIGW : POST /consultations\n(patientId, physicianId, dateTime, ...)
APIGW -> SchedCmd : POST /consultations\n(patientId, physicianId, dateTime, ...)

activate SchedCmd
SchedCmd -> WDB : INSERT Consultation\n(status = PENDING)
WDB --> SchedCmd : OK

SchedCmd -> Broker : publish ConsultationSchedulingStarted
deactivate SchedCmd

== Saga: validação de paciente e médico ==

Broker -> PatSvc : ConsultationSchedulingStarted
activate PatSvc
PatSvc -> PatSvc : validar patientId
PatSvc -> Broker : publish PatientValidatedForConsultation
deactivate PatSvc

Broker -> DocSvc : ConsultationSchedulingStarted
activate DocSvc
DocSvc -> DocSvc : validar physicianId & disponibilidade
DocSvc -> Broker : publish PhysicianAvailabilityConfirmed
deactivate DocSvc

== Orquestrador reage aos eventos ==

Broker -> SchedCmd : PatientValidatedForConsultation
Broker -> SchedCmd : PhysicianAvailabilityConfirmed
activate SchedCmd
SchedCmd -> WDB : UPDATE Consultation\nstatus = CONFIRMED
WDB --> SchedCmd : OK

SchedCmd -> Broker : publish ConsultationScheduled
deactivate SchedCmd

== Atualização dos read models (CQRS) ==

Broker -> SchedQ1 : ConsultationScheduled
activate SchedQ1
SchedQ1 -> RDB1 : UPSERT consulta\npara read model do paciente
RDB1 --> SchedQ1 : OK
deactivate SchedQ1

== Query: paciente vê as consultas ==

PatientUI -> APIGW : GET /consultations?patientId=...
APIGW -> SchedQ1 : GET /consultations?patientId=...

activate SchedQ1
SchedQ1 -> RDB1 : SELECT consultas\nWHERE patientId=...
RDB1 --> SchedQ1 : lista de consultas
SchedQ1 --> APIGW : 200 OK\nlista de consultas
deactivate SchedQ1

APIGW --> PatientUI : 200 OK\nlista de consultas futuras

@enduml
