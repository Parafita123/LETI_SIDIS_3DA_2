@startuml
title US12 - Relatório Mensal de Consultas (com IdentityService)

actor "Administrator" as User
participant ":Frontend" as Frontend
participant ":API Gateway" as Gateway
participant ":IdentityService" as IdentitySvc
participant AppointmentController as Controller
participant AppointmentServiceImpl as Service
participant AppointmentRepository as Repo
database "H2Database" as DB

autonumber

group Fase 1: Autenticação do Administrador

    User -> Frontend : Inicia login com credenciais
    Frontend -> Gateway : 1. POST /auth/login
    Gateway -> IdentitySvc : 1.1. Validar credenciais
    IdentitySvc --> Gateway : 1.2. Retorna Token JWT (contendo **role: ADMIN**)
    Gateway --> Frontend : 1.3. Retorna Token JWT
    Frontend --> User : Login bem-sucedido

end

group Fase 2: Geração do Relatório Mensal (Ação Autorizada)

    User -> Frontend : Solicita o relatório para um ano e mês específicos

    Frontend -> Gateway : 2. GET /appointments/stats/monthly-report?year={y}&month={m} (**Authorization: Bearer <JWT>**)

    Gateway -> Gateway : 3. Valida a assinatura, expiração e permissões (role: ADMIN) do JWT

    Gateway -> Controller : 4. GET /stats/monthly-report?year={y}&month={m}

    Controller -> Service : 5. getMonthlyReport({y}, {m})

    Service -> Repo : 6. findByYearAndMonth({y}, {m})
    Repo -> DB : 6.1. SELECT * FROM appointments WHERE YEAR(date) = {y} AND MONTH(date) = {m}
    DB --> Repo : 6.2. Retorna lista de consultas do mês
    Repo --> Service : 6.3. Retorna List<Appointment>

    Service -> Service : 7. Processa a lista: conta totais, canceladas, reagendadas
    Service -> Service : 8. Cria e preenche o objeto ConsultasReportDTO

    Service --> Controller : 9. Retorna ConsultasReportDTO preenchido

    Controller --> Gateway : 10. HTTP 200 OK + JSON com ConsultasReportDTO

    Gateway --> Frontend : 11. HTTP 200 OK + JSON

    Frontend --> User : 12. Mostra o relatório

end
@enduml