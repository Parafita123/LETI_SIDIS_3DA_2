@startuml
title Médico a Registar Detalhes de uma Consulta (a partir do Token)

actor "Médico" as User
participant ":Frontend" as Frontend
participant ":API Gateway" as Gateway
participant ":IdentityService" as IdentityService
participant AppointmentRecordController as Controller
participant AppointmentRecordServiceImpl as Service
participant AppointmentRecordRepository as Repo
database "H2Database" as DB

autonumber

group Fase 1: Autenticação do Médico

    User -> Frontend : Inicia login com credenciais
    Frontend -> Gateway : 1. POST /auth/login
    Gateway -> IdentityService : 1.1. Validar credenciais
    IdentityService --> Gateway : 1.2. Retorna Token JWT (contendo **physician_id**)
    Gateway --> Frontend : 1.3. Retorna Token JWT
    Frontend -> Frontend : 1.4. Armazena o token de forma segura
    Frontend --> User : Login bem-sucedido

end

group Fase 2: Registo dos Detalhes da Consulta (Ação Autorizada)

    User -> Frontend : Submete formulário com detalhes (diagnóstico, tratamento, etc.)

    Frontend -> Gateway : 2. POST /appointment-records/{id}/details (JSON, **Authorization: Bearer <JWT>**)

    Gateway -> Gateway : 3. Valida a assinatura e expiração do JWT

    Gateway -> Gateway : 4. Extrai **physician_id** do payload do token

    Gateway -> Controller : 5. POST /{id}/details (JSON, Header: **X-Physician-ID: {id_do_medico}**)

    Controller -> Service : 6. recordAppointmentDetails({id}, {detailsDto}, {id_do_medico})

    ' O Serviço primeiro verifica se o médico autenticado é o dono da consulta
    Service -> Repo : 7. findAppointmentRecordById({id})
    Repo --> Service : 7.1. Retorna registo da consulta (que contém o ID do médico original)
    Service -> Service : 7.2. **Verifica se o ID do médico do registo == {id_do_medico}**

    ' Se a verificação for bem-sucedida, continua a operação de gravação
    Service -> Repo : 8. saveAppointmentDetails({details})
    Repo -> DB : 8.1. INSERT INTO appointment_details (...)
    DB --> Repo : 8.2. Retorna detalhes guardados
    Repo --> Service : 8.3. Retorna entidade AppointmentDetails
    Service -> Service : 9. Mapeia entidade para AppointmentDetailsDto
    Service --> Controller : 10. Retorna AppointmentDetailsDto

    Controller --> Gateway : 11. HTTP 201 Created + JSON

    Gateway --> Frontend : 12. HTTP 201 Created + JSON

    Frontend --> User : 13. Exibe mensagem "Detalhes registados com sucesso!"

end
@enduml